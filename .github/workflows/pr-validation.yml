name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

env:
  NODE_VERSION: '18.x'

jobs:
  # Job 1: PR Validation
  validate:
    name: ğŸ” PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ” Check for breaking changes
        run: |
          echo "ğŸ” Checking for breaking changes..."
          git diff --name-only origin/main...HEAD
          
      - name: ğŸ“Š Run quick tests
        run: |
          echo "ğŸ“Š Running quick validation tests..."
          npm run test --workspace @personal-trainer/api -- --passWithNoTests
          
      - name: ğŸ—ï¸ Test build
        run: |
          echo "ğŸ—ï¸ Testing build process..."
          npm run build --workspace @personal-trainer/api
          npm run build --workspace @personal-trainer/web

  # Job 2: Code Review Bot
  code-review:
    name: ğŸ¤– Automated Code Review
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ¤– Run automated review
        uses: actions/github-script@v6
        with:
          script: |
            const { execSync } = require('child_process');
            
            // Get changed files
            const changedFiles = execSync('git diff --name-only origin/main...HEAD', { encoding: 'utf8' })
              .split('\n')
              .filter(file => file.trim() !== '');
            
            console.log('Changed files:', changedFiles);
            
            // Basic checks
            let issues = [];
            
            changedFiles.forEach(file => {
              if (file.endsWith('.ts') || file.endsWith('.tsx')) {
                // Check for TODO comments
                try {
                  const content = require('fs').readFileSync(file, 'utf8');
                  const todoMatches = content.match(/TODO:|FIXME:|XXX:/gi);
                  if (todoMatches) {
                    issues.push(`âš ï¸ Found ${todoMatches.length} TODO/FIXME comments in ${file}`);
                  }
                  
                  // Check for console.log
                  const consoleMatches = content.match(/console\.(log|warn|error)/gi);
                  if (consoleMatches) {
                    issues.push(`âš ï¸ Found ${consoleMatches.length} console statements in ${file}`);
                  }
                } catch (e) {
                  // File might not exist in working directory
                }
              }
            });
            
            // Post review comment
            const reviewComment = `## ğŸ¤– Automated Code Review
            
            **Files changed:** ${changedFiles.length}
            
            ${issues.length > 0 ? 
              '### âš ï¸ Issues Found:\n' + issues.map(issue => `- ${issue}`).join('\n') :
              '### âœ… No issues found!'
            }
            
            ### ğŸ“ Review Checklist:
            - [ ] Tests added/updated for new functionality
            - [ ] Documentation updated if needed
            - [ ] No breaking changes without proper migration
            - [ ] Code follows project conventions
            - [ ] Performance considerations addressed
            
            _This is an automated review. Manual review is still required._
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewComment
            });

  # Job 3: Performance Check
  performance:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: âš¡ Bundle size analysis
        run: |
          echo "âš¡ Analyzing bundle size..."
          cd apps/web
          npm run build
          
          # Basic bundle size check
          if [ -d "build/static/js" ]; then
            total_size=$(du -sh build/static/js | cut -f1)
            echo "ğŸ“¦ Total JS bundle size: $total_size"
            
            # Check if any single file is too large (>2MB)
            find build/static/js -name "*.js" -size +2M | while read file; do
              size=$(du -sh "$file" | cut -f1)
              echo "âš ï¸ Large bundle detected: $file ($size)"
            done
          fi
          
      - name: ğŸš€ API performance test
        run: |
          echo "ğŸš€ Running basic API performance tests..."
          cd apps/api
          npm run build
          
          # Start API in background for testing
          npm start &
          API_PID=$!
          
          # Wait for API to start
          sleep 10
          
          # Basic response time test
          response_time=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:3001/api/test || echo "0")
          echo "ğŸ“Š API response time: ${response_time}s"
          
          # Cleanup
          kill $API_PID || true
